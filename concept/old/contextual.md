
---

# CONCEPT: Контекст-ориентированные уточняющие вопросы для генерации скелета

## 1. Цель

При выборе пользователем `document_type` (например, «договор поставки») система должна:

1. Через **серии контекстных вопросов** понять:

   * бизнес-сценарий сделки,
   * предмет и структуру обязательств,
   * ключевые параметры (экономика, сроки, объём, особые условия, риски),
2. Использовать **этот контекст как главный источник** для генерации skeleton-а.
3. Формальные реквизиты сторон (полные наименования, ИНН и т.п.):

   * **не являются приоритетными**,
   * могут вообще не спрашиваться на этом шаге, либо идти в самом конце.

---

## 2. Основной принцип

> **Контекст сделки важнее реквизитов.**
> Пока система не понимает, что именно стороны собираются делать и на каких базовых условиях, она не имеет права завершать сбор контекста и генерировать skeleton.

---

## 3. Два LLM-шага: «Следующий вопрос» и «Оценка полноты контекста»

### 3.1. `generateNextQuestion` — контекстный вопрос

* Вход:

  * `document_type`
  * `qa_context` (история Q&A)
* Задача модели:

  * проанализировать уже полученные ответы;
  * определить, **какого куска контекста ещё не хватает**;
  * задать **один следующий вопрос**, максимально:

    * привязанный к `document_type`,
    * опирающийся на уже данные ответы,
    * раскрывающий новую грань контекста (а не реквизиты).

Типично для договора поставки это будут вопросы про:

* Что именно поставляем? (номенклатура/тип товара, разовая/повторяющаяся поставка)
* Как предполагается строить расчёты? (фикс, диапазон, формула, постоплата/предоплата)
* Какой ожидается график / срок поставки?
* Есть ли особые условия/риски (штрафы, качество, эксклюзивность, SLA и т.п.)?

**Важно:**
В промпте для этого шага нужно явно прописать, что:

* **вопросы про реквизиты сторон имеют низкий приоритет** и:

  * либо задаются в самом конце,
  * либо вообще опускаются на этом этапе;
* каждый новый вопрос должен:

  * **не повторять** уже заданные темы;
  * раскрывать **новый аспект** контекста, который может повлиять на структуру документа.

### 3.2. `checkContextCompletion` — достаточно ли контекста

Сейчас модель просто говорит «достаточно / нет» и, судя по примеру, решила, что одних сторон хватит.

Нужно изменить контракт:

* Модель должна не только вернуть `is_complete`, но и **оценку покрытия ключевых контекстных измерений**.

Например, ожидаемый JSON:

```json
{
  "is_complete": true,
  "reason": "Есть ключевой контекст",
  "coverage": {
    "scenario": true,
    "subject": true,
    "obligations": true,
    "economics": true,
    "timing": true,
    "special_terms": false,
    "party_details": false
  }
}
```

Где:

* `scenario` — общая ситуация и цели сторон;
* `subject` — что является предметом договора;
* `obligations` — кто что делает / поставляет / принимает;
* `economics` — базовая логика цены и расчётов;
* `timing` — срок/график поставки/оказания;
* `special_terms` — критичные особые условия (штрафы, эксклюзивы, SLA, опции и т.п.);
* `party_details` — формальные реквизиты.

**Жёсткое локальное правило поверх ответа модели:**

Skeleton можно генерировать **только если** (независимо от того, что вернул LLM):

* `scenario == true`
* `subject == true`
* `obligations == true`
* `economics == true` **ИЛИ** `timing == true` (минимум одно)
* `is_complete == true` по версии модели

А `party_details` можно игнорировать при принятии решения — они не обязательны.

Если хотя бы одно из этих полей `false` → `is_complete` принудительно считаем `false` и задаём ещё один вопрос.

---

## 4. Как добиться контекстности самих вопросов

### 4.1. Промпт для `question-generation.md`

Основные принципы, которые нужно явно описать в промпте:

1. **Документ-специфичность**

   * Модель должна мыслить как юрист именно по этому типу документа:

     * «договор поставки», «договор подряда», «агентский», «лицензионный» и т.п.
   * Для каждого типа свои естественные «контекстные оси» (товар, услуги, IP, территория, KPI и т.п.).

2. **Контекст-driven**

   * Вопросы должны опираться на уже собранные ответы (`qa_context`) — не спрашивать то же самое в других словах.
   * Каждый новый вопрос должен либо:

     * уточнять уже затронутую тему, но на уровне, важном для структуры договора,
     * либо открывать новую тему, которая ещё не покрыта (предмет, цена, срок, риски, механика работы и т.п.).

3. **Приоритеты тем**

   * Сначала: *суть сделки* (что делают стороны, зачем, на каких базовых условиях).
   * Потом: цена/сроки/объём/риски.
   * В самом конце (и только при необходимости): формальные реквизиты сторон.
   * Нельзя считать процесс завершённым, если были только вопросы про реквизиты.

4. **Один вопрос за раз**

   * В одном вопросе можно спрашивать **1–3 связанных аспекта**, но он должен быть читаемым и не слишком тяжёлым.

### 4.2. Промпт для `context-completion.md`

Добавить явные критерии:

* контекст считается **недостаточным**, если:

  * неизвестно, **что** является предметом;
  * непонятно, **кто и что делает**;
  * нет хотя бы приблизительного понимания **как считается и платится**;
* наличие только реквизитов сторон **никогда** не является достаточным для генерации skeleton-а.

---

## 5. Как это ложится на твою идею самообучения

Всё, что спрашивает LLM в этом диалоге, можно:

* после завершения пайплайна сохранить в инструкции в Pinecone:

  * список вопросов,
  * структура ответов,
  * возможно — выделенные моделью «контекстные измерения» (coverage),
* и использовать в следующих сессиях как основу для:

  * предзаполненного опросника,
  * рекомендаций skeleton-генератору, какие блоки важны.

Но в отличие от жёсткого профиля полей, **здесь “осевые” темы и сами вопросы рождаются LLM-ом**, только критерии достаточности мы фиксируем руками.

---

## 6. Почему после этого не будет кейса «спросили только стороны»

Потому что:

1. Промпт явно говорит:

   * «Реквизиты — низкий приоритет, не считать их достаточными».
2. `checkContextCompletion` возвращает структуру `coverage`, где:

   * пока `scenario/subject/obligations/economics` не покрыты, `is_complete` принудительно = `false`.
3. Локальная логика **не даёт** завершить контекст на одном вопросе про стороны, даже если модель ошиблась.

---

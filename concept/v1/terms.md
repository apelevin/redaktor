

## Задача: Ввести слой «Термины и определения» и перестать дублировать длинные описания по всему документу

### Цель

Сделать так, чтобы:

1. Ключевые сущности договора (объект, стороны, сам договор, доп. объекты) **определялись один раз** в начале (или в специальном разделе «Определения»),
2. Во всех последующих разделах текст использовал **краткие термины** (“Автомобиль”, “Квартира”, “Услуги”, “Продукт”, “Договор”, “Стороны”),
3. Модель **не повторяла** каждый раз полные описания (марка, модель, VIN, адрес, полное наименование услуги и т.п.),
4. Это работало **для любых типов документов** (аренда, услуги, купля-продажа, NDA, акты, соглашения и т.д.).

---

## 1. Общая концепция

Добавить в пайплайн Право(редактор) отдельный слой **“terms”**:

* На основе собранного контекста (шаг вопросов) формируется **словарь терминов**: ключевые сущности → краткое имя + определение.
* Skeleton (структура документа) гарантированно содержит либо:

  * отдельный раздел «Термины и определения» / «Определения»,
  * либо специальные пункты (например, в «Предмете»), куда эти определения попадают.
* На шаге генерации текста пунктов (document-item-generation) в промпт добавляется этот словарь, и LLM даются **жёсткие правила**:

  * полное описание сущности — только в пункте с определением,
  * в остальных разделах использовать **только термин**, без повторного раскрытия.

---

## 2. Изменения в пайплайне (высокоуровнево)

### 2.1. Новый модуль: формирование словаря терминов

Добавить шаг (функцию) после завершения сбора контекста (после всех вопросов):

```ts
interface Term {
  name: string;        // "Автомобиль", "Квартира", "Услуги", "Продукт", "Договор", "Стороны" и т.п.
  definition: string;  // Полное описание/идентификация
  role?: string;       // "main_object", "party", "contract", "service", "document", etc.
}

type TermsDictionary = Term[];
```

Задача этого шага:

1. На основе `generated_context` (структурного JSON + summary):

   * Выделить **основной объект** договора:

     * недвижимость (квартира, дом, нежилое помещение),
     * движимое имущество (авто, оборудование, техника),
     * услуги,
     * работы,
     * цифровой продукт,
     * и т.п.
   * Выделить **сам договор** (“настоящий договор” → “Договор”).
   * Выделить **стороны**:

     * “Продавец”, “Покупатель”,
     * “Арендодатель”, “Арендатор”,
     * “Заказчик”, “Исполнитель”,
     * “Стороны” как совокупность.

2. Сформировать для каждой такой сущности:

   * `name` — короткий термин с заглавной буквы (“Автомобиль”, “Квартира”, “Услуги”, “Продукт”, “Договор”, “Стороны”).
   * `definition` — одна ёмкая фраза с полным описанием:

     * для объектов: марка/модель/год/VIN, адрес, реквизиты, инвентарный номер и т.п.;
     * для услуг/работ: краткое, но достаточно точное описание;
     * для договора: ссылка на настоящий документ;
     * для сторон: ФИО/наименование/реквизиты.

3. Сохранить словарь терминов в общем контексте пайплайна:

```ts
interface GeneratedContext {
  // ... всё, что уже есть
  terms?: TermsDictionary;
}
```

---

### 2.2. Изменения в `skeleton-generation`

**Цель:** гарантировать место для определений.

1. Для всех типов документов в skeleton:

   * либо добавляем **раздел `definitions`** (например, `id: "definitions"`, `title: "Термины и определения"`),
   * либо внутри раздела «Предмет»/«Объект договора» добавляем один пункт:

     * `text: "Определение ключевых терминов и объекта договора"`, `importance: "core"`.

2. Для документов с явно выраженным объектом (аренда, купля-продажа, услуги):

   * минимум один пункт в skeleton должен быть типа:

     * «Определение термина “Автомобиль” (идентификация транспортного средства)»,
     * «Определение термина “Квартира” (идентификация объекта недвижимости)»,
     * «Определение термина “Услуги” (описание оказываемых услуг)»,
     * «Определение термина “Продукт”» и т.п.

3. Для любых договоров skeleton должен предусматривать:

   * термин “Договор” (сам документ),
   * термин “Стороны” (если это уместно для данного типа).

---

### 2.3. Изменения в `document-item-generation` (промпт и данные)

**Добавить в промпт:**

1. Входные данные дополняются:

```text
Определённые термины (если есть):

{{terms}}
```

Где `terms` сериализуются в виде:

* `"Автомобиль" — принадлежащий Продавцу легковой автомобиль Toyota Camry 2018 года выпуска, белого цвета, VIN ...`
* `"Квартира" — расположенное по адресу ... жилое помещение ...`
* `"Услуги" — услуги по ...`
* `"Договор" — настоящий договор ...`
* `"Стороны" — ...`

2. В требованиях промпта явно прописать правила:

* Если для сущности (основного объекта, договора, сторон и т.п.) **есть термин в `terms`**, то:

  * Полное описание (марка, модель, VIN, адрес, реквизиты и т.п.):
    – допускается **только** в том пункте, который отвечает за определение термина (раздел “Термины”, пункт “Определение Автомобиля/Квартиры/Услуг” и т.п.).
  * Во всех остальных пунктах:
    – использовать **только термин с заглавной буквы**, без повтора полных реквизитов.

Пример:

> ❌ НЕ ПРАВИЛЬНО:
> “Автомобиль Toyota Camry 2018 года выпуска, VIN JTNB..., белого цвета…” в разделе про оплату.
>
> ✅ ПРАВИЛЬНО:
> “Покупатель обязуется оплатить Автомобиль по цене …”.

* Для режимов:

  * `short`: правило особенно жёсткое — никакого повтора полных описаний нигде, кроме определения.
  * `standard`: допускается повтор идентификации 1–2 раза (например, в предмете и в передаче), но не в каждом разделе.
  * `extended`/`expert`: можно чуть чаще повторять, но **только если это оправдано** (например, в актах, специальных разделах).

---

## 3. Пример, как это должно работать в общем виде (любой документ)

### Пример: договор оказания услуг

1. В контексте есть:

* Исполнитель, Заказчик, описание услуг (разработка сайта, сопровождение, аналитика и т.п.).

2. Шаг терминов формирует:

* `"Услуги" — комплекс работ и действий Исполнителя по разработке и сопровождению веб-сайта, оказываемых Заказчику на условиях настоящего договора.`
* `"Договор" — настоящий договор оказания услуг…`
* `"Стороны" — Исполнитель и Заказчик`
* при необходимости — отдельные термины для модулей/продуктов.

3. Skeleton содержит пункт:

* «Определение термина “Услуги” (описание объёма и существа услуг)».

4. На шаге генерации текста:

* В разделе “Определения/Предмет”:

  * даём полное развернутое определение “Услуги”.
* В других разделах:

  * пишем “Услуги”, а не каждый раз “комплекс работ и действий по разработке и сопровождению веб-сайта…”.

---

## 4. Требования к реализации

1. **Не ломать текущие типы документов**:
   – если `terms` пустой, система должна работать, как раньше.

2. **Обязательная интеграция:**

   * формирование `terms` → запись в `generated_context`,
   * прокидывание `terms` в `skeleton-generation` (чтобы skeleton умел делать пункты для определений),
   * прокидывание `terms` в `document-item-generation` и обновление промпта согласно правилам.


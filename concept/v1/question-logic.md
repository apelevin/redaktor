# Логика формирования уточняющих вопросов

## Обзор

В системе право(редактор) уточняющие вопросы формируются на двух этапах пайплайна:

1. **Шаг 1 (ChatPanel)** — сбор базового контекста документа через диалог
2. **Шаг 3 (SkeletonChatPanel)** — уточнение деталей для конкретных пунктов скелета

Вопросы могут отображаться в трех форматах UI:
- **`open`** — открытый текстовый ответ (textarea)
- **`single`** — выбор одного варианта из списка (radio buttons)
- **`multi`** — выбор нескольких вариантов (checkboxes)

## Типы вопросов и их использование

### 1. Открытые вопросы (`uiKind: 'open'`)

**Когда используется:**
- Для сложных параметров, которые требуют свободного описания
- Когда заранее невозможно перечислить все возможные варианты
- Для сбора первичной информации, которая затем может быть уточнена структурированными вопросами
- Когда нужен произвольный текст от пользователя без ограничений

**Примеры использования:**
- "Как вы видите порядок расчётов по договору? Опишите своими словами."
- "Опишите предмет договора своими словами."
- "Какие особые условия нужно учесть?"

**UI компонент:** `OpenQuestion.tsx`
- Отображает `textarea` для ввода текста
- Минимальная валидация: проверка на пустоту для обязательных вопросов
- Пользователь вводит произвольный текст

**Особенности:**
- Не требует предопределенных вариантов ответа
- Позволяет собрать максимально полную информацию от пользователя
- Ответ обрабатывается LLM для извлечения структурированных данных

---

### 2. Вопросы с выбором одного варианта (`uiKind: 'single'`)

**Когда используется:**
- Когда есть ограниченное количество типичных вариантов ответа
- Для выбора типа сущности (тип стороны, модель оплаты, применимое право)
- Для вопросов "да/нет" с возможностью детализации
- Когда нужен однозначный выбор из предопределенного списка

**Примеры использования:**
- "Кто будет исполнителем по договору?" (Юридическое лицо / ИП / Физическое лицо)
- "Нужно ли включить условия о форс-мажоре?" (Да / Нет)
- "Какой вариант лучше всего описывает порядок оплаты?" (Предоплата / Постоплата / Поэтапно)

**UI компонент:** `SingleChoiceQuestion.tsx`
- Отображает список `radio buttons` для выбора одного варианта
- Поддерживает опцию "Другое" (`allowOther: true`) — текстовое поле для собственного варианта
- Поддерживает условное текстовое поле (`conditionalText: true`) — появляется при выборе положительной опции (да/yes)

**Особенности:**

#### Условное текстовое поле (`conditionalText`)
Если вопрос имеет `conditionalText: true` и пользователь выбирает положительную опцию (значения: "yes", "да", "true", "1", "y"), то:
- Показывается дополнительное текстовое поле (`textarea`)
- Пользователь может описать детали выбранного варианта
- Ответ сохраняется как объект: `{ option: string, details: string }`

**Пример:**
```json
{
  "text": "Нужно ли включить условия о форс-мажоре?",
  "uiKind": "single",
  "conditionalText": true,
  "conditionalTextLabel": "Опишите, какие события учитывать",
  "options": [
    { "id": "yes", "label": "Да", "value": "yes" },
    { "id": "no", "label": "Нет", "value": "no" }
  ]
}
```

При выборе "Да" появляется поле для описания деталей форс-мажора.

#### Поле "Другое" (`allowOther`)
Если `allowOther: true`:
- Показывается текстовое поле "Другое"
- Пользователь может ввести свой вариант ответа
- При фокусе на поле автоматически выбирается опция "other"

---

### 3. Вопросы с множественным выбором (`uiKind: 'multi'`)

**Когда используется:**
- Когда логично выбрать несколько вариантов одновременно
- Для перечисления множественных сущностей (виды услуг, случаи ответственности, способы защиты)
- Когда нужно собрать список значений из предопределенного набора

**Примеры использования:**
- "Какие типы услуг будут оказываться? Можно выбрать несколько вариантов."
- "Какие случаи ответственности нужно включить?"
- "Какие способы защиты интересов предусмотреть?"

**UI компонент:** `MultiChoiceQuestion.tsx`
- Отображает список `checkboxes` для множественного выбора
- Поддерживает опцию "Другое" (`allowOther: true`) — можно добавить несколько собственных вариантов
- Пользователь может выбрать несколько опций одновременно

**Особенности:**

#### Поле "Другое" (`allowOther`)
Если `allowOther: true`:
- Показывается возможность добавить несколько текстовых полей "Другое"
- Кнопка "+ Добавить еще вариант" позволяет добавить дополнительные поля
- Все выбранные опции и введенные "другие" варианты объединяются в массив ответов

---

## Логика выбора типа вопроса

### Правила выбора `uiKind` (из промптов)

#### Для шага 1 (`question-generation.md`):

1. **`open`** — для сложных параметров, которые требуют свободного описания
2. **`single`** — для выбора одного варианта из списка (тип стороны, модель оплаты и т.д.)
3. **`multi`** — для перечисления нескольких вариантов (виды услуг, случаи ответственности и т.д.)

#### Для шага 3 (`skeleton-item-question.md`):

1. **`single`** — если есть ограниченное количество типичных вариантов (например: «предоплата / постоплата / поэтапно»)
2. **`multi`** — если логично выбрать несколько опций (например: «какие услуги включить?»)
3. **`open`** — если заранее невозможно перечислить варианты или нужно свободное описание

### Критерии выбора

**Выбирай `single`, если:**
- Есть четкий список вариантов (2-7 опций)
- Нужен однозначный выбор
- Варианты взаимоисключающие
- Примеры: тип стороны, модель оплаты, применимое право, да/нет вопросы

**Выбирай `multi`, если:**
- Можно выбрать несколько вариантов одновременно
- Варианты не взаимоисключающие
- Нужно собрать список значений
- Примеры: виды услуг, случаи ответственности, способы защиты

**Выбирай `open`, если:**
- Невозможно заранее перечислить все варианты
- Нужно свободное описание
- Параметр сложный и требует детального объяснения
- Примеры: описание предмета договора, порядок расчетов, особые условия

---

## Особенности для разных шагов пайплайна

### Шаг 1: Сбор базового контекста

**Промпт:** `prompts/question-generation.md`

**Особые правила:**
- **НЕ спрашивать точные реквизиты сторон** на первом шаге:
  - НЕ спрашивать: названия организаций, ФИО, ИНН, ОГРН, адреса, номера банковских счетов
  - ДОСТАТОЧНО спросить только ТИП сторон: физическое лицо, юридическое лицо, ИП
  - Точные реквизиты будут уточняться на шаге 3

**Примеры правильных вопросов:**
- "Кто будет заказчиком по договору?" с вариантами "Юридическое лицо", "Физическое лицо", "ИП"
- "Как вы видите порядок расчётов?" (открытый вопрос)

**Примеры НЕПРАВИЛЬНЫХ вопросов:**
- "Укажите полное наименование организации"
- "Введите ИНН"
- "Укажите номер банковского счета"

**Уровни важности (`requiredLevel`):**
- `must` — без этого нельзя безопасно собирать договор (типы сторон, сумма, предмет, срок, применимое право)
- `recommended` — полезные юридически важные уточнения (штрафы, лимит ответственности, подробные условия ПДн, SLA)
- `optional` — косметика и экзотика (количество экземпляров, дополнительные уведомления, спец. стилистика)

---

### Шаг 3: Уточнение деталей для пунктов скелета

**Промпт:** `prompts/skeleton-item-question.md`

**Особые правила:**
- **Один пункт = один вопрос** (максимум)
- Вопрос должен быть строго связан с конкретным пунктом скелета
- Не задавать вопросы, если информация уже есть в `generated_context` или `existing_answers`
- Не задавать дубликаты вопросов по одной теме

**Когда вопрос НЕ нужен:**
- Вся информация уже есть в `generated_context`
- Пункт является типовым и может быть сформулирован стандартной конструкцией
- Пользователь явно указал, что специальных условий нет
- Тема пункта уже спрашивалась ранее

**Когда вопрос НУЖЕН:**
- Для корректной формулировки пункта явно не хватает данных
- В пункте есть критичная неопределённость (что, кто, когда, в каком объёме)
- От выбора пользователя зависит юридическая модель
- Данные невозможно разумно восстановить автоматически из контекста

**Влияние режима детализации (`document_mode`):**

- **`short`** — задавать вопрос ТОЛЬКО если без него невозможно создать юридически корректный текст
- **`standard`** — задавать вопросы только по параметрам, которые реально влияют на формулировку
- **`extended`** — можно задавать дополнительные вопросы для более точной формулировки
- **`expert`** — можно задавать вопросы для большинства пунктов, если есть хоть небольшая неопределённость

---

## Структура вопроса

### Базовые поля

```typescript
interface Question {
  id: string;                // уникальный ID вопроса
  documentType: string;        // тип документа
  text: string;              // формулировка вопроса для пользователя
  uiKind: 'open' | 'single' | 'multi';  // формат UI
  valueType: 'string' | 'number' | 'boolean' | 'enum' | 'enum[]' | 'date' | 'money';
  isRequired: boolean;       // обязателен ли вопрос (back-compat)
  requiredLevel?: 'must' | 'recommended' | 'optional'; // уровень важности
  affects: string[];         // на какие поля контекста влияет ответ
}
```

### Поля для `single` и `multi`

```typescript
{
  options?: QuestionOption[]; // варианты ответа
  allowOther?: boolean;       // можно ли дописать свой вариант
  conditionalText?: boolean;  // если true, при выборе "да" показывается текстовое поле
  conditionalTextLabel?: string; // кастомная подпись для условного текстового поля
}
```

### Поля зависимостей

```typescript
{
  dependsOn?: string[];      // зависимости (пути в контексте)
  order?: number;            // порядок вопроса
}
```

---

## Примеры вопросов

### Пример 1: Открытый вопрос (шаг 1)

```json
{
  "id": "service_contract.payment.description",
  "documentType": "service_contract",
  "text": "Как вы видите порядок расчётов по договору? Опишите своими словами.",
  "uiKind": "open",
  "valueType": "string",
  "isRequired": true,
  "requiredLevel": "must",
  "affects": ["payment.rawDescription"]
}
```

**Отображается как:** `textarea` для свободного ввода текста

---

### Пример 2: Выбор одного варианта (шаг 1)

```json
{
  "id": "service_contract.party.executor_type",
  "documentType": "service_contract",
  "text": "Кто будет исполнителем по договору?",
  "uiKind": "single",
  "valueType": "enum",
  "isRequired": true,
  "requiredLevel": "must",
  "options": [
    {
      "id": "legal_entity",
      "label": "Юридическое лицо (ООО, АО и т.п.)",
      "value": "legal_entity"
    },
    {
      "id": "sole_entrepreneur",
      "label": "Индивидуальный предприниматель (ИП)",
      "value": "sole_entrepreneur"
    },
    {
      "id": "individual",
      "label": "Физическое лицо",
      "value": "individual"
    }
  ],
  "allowOther": false,
  "affects": ["parties.executor.type"]
}
```

**Отображается как:** Список `radio buttons` для выбора одного варианта

**Примечание:** Этот вопрос спрашивает только ТИП стороны, а не точные реквизиты. Точные реквизиты будут уточняться на шаге 3.

---

### Пример 3: Выбор одного варианта с условным полем (шаг 1)

```json
{
  "id": "service_contract.force_majeure",
  "documentType": "service_contract",
  "text": "Нужно ли включить в договор условия о форс-мажоре (обстоятельства непреодолимой силы)?",
  "uiKind": "single",
  "valueType": "enum",
  "isRequired": true,
  "requiredLevel": "recommended",
  "conditionalText": true,
  "conditionalTextLabel": "Опишите, какие события учитывать и порядок уведомления контрагента",
  "options": [
    { "id": "yes", "label": "Да", "value": "yes" },
    { "id": "no", "label": "Нет", "value": "no" }
  ],
  "affects": ["forceMajeure"]
}
```

**Отображается как:** 
- Список `radio buttons` (Да / Нет)
- При выборе "Да" появляется `textarea` для описания деталей

---

### Пример 4: Множественный выбор (шаг 1)

```json
{
  "id": "service_contract.subject.service_types",
  "documentType": "service_contract",
  "text": "Какие типы услуг будут оказываться? Можно выбрать несколько вариантов.",
  "uiKind": "multi",
  "valueType": "enum[]",
  "isRequired": true,
  "requiredLevel": "must",
  "options": [
    { "id": "dev", "label": "Разработка ПО", "value": "dev" },
    { "id": "support", "label": "Техническая поддержка", "value": "support" },
    { "id": "consulting", "label": "Консалтинг", "value": "consulting" }
  ],
  "allowOther": true,
  "affects": ["subject.serviceTypes"]
}
```

**Отображается как:** 
- Список `checkboxes` для множественного выбора
- Поле "Другое" с возможностью добавить несколько вариантов

---

### Пример 5: Вопрос для пункта скелета (шаг 3)

```json
{
  "question": {
    "id": "service_contract.section-1.item0.q1",
    "documentType": "service_contract",
    "text": "Какой порядок оплаты предусмотреть: предоплата, постоплата или поэтапная оплата?",
    "uiKind": "single",
    "valueType": "enum",
    "isRequired": true,
    "requiredLevel": "must",
    "options": [
      { "id": "prepayment", "label": "Предоплата", "value": "prepayment" },
      { "id": "postpayment", "label": "Постоплата", "value": "postpayment" },
      { "id": "staged", "label": "Поэтапная оплата", "value": "staged" }
    ],
    "affects": ["payment.method"]
  },
  "reason": "Необходимо уточнить порядок оплаты для корректной формулировки пункта"
}
```

**Отображается как:** Список `radio buttons` для выбора одного варианта

---

## Обработка ответов

### Открытый вопрос (`open`)

**Ввод:** Произвольный текст в `textarea`

**Ответ:**
```typescript
{
  raw: string;  // введенный текст
  selectedOptionIds: [];  // пустой массив
}
```

**Пример:**
```json
{
  "raw": "Мы хотим заключить договор на год, с автопродлением, если никто не возражает"
}
```

---

### Выбор одного варианта (`single`)

**Ввод:** Выбор одной `radio button`

**Ответ (обычный):**
```typescript
{
  raw: string;  // label выбранной опции
  selectedOptionIds: [string];  // [id выбранной опции]
}
```

**Ответ (с условным полем):**
```typescript
{
  raw: { option: string, details: string };  // опция + детали
  selectedOptionIds: [string];  // [id выбранной опции]
}
```

**Ответ (с "Другое"):**
```typescript
{
  raw: string;  // введенный текст
  selectedOptionIds: ['other'];
}
```

**Примеры:**
```json
// Обычный выбор
{
  "raw": "Юридическое лицо (ООО, АО и т.п.)",
  "selectedOptionIds": ["legal_entity"]
}

// С условным полем
{
  "raw": {
    "option": "Да",
    "details": "Стихийные бедствия, военные действия, действия государственных органов"
  },
  "selectedOptionIds": ["yes"]
}

// С "Другое"
{
  "raw": "Государственное унитарное предприятие",
  "selectedOptionIds": ["other"]
}
```

---

### Множественный выбор (`multi`)

**Ввод:** Выбор нескольких `checkboxes` + опционально поля "Другое"

**Ответ:**
```typescript
{
  raw: string[];  // массив label выбранных опций + тексты из "Другое"
  selectedOptionIds: string[];  // массив id выбранных опций
}
```

**Пример:**
```json
{
  "raw": ["Разработка ПО", "настройка маркетинговых интеграций"],
  "selectedOptionIds": ["dev"]
}
```

---

## Валидация и ограничения

### Обязательные вопросы (`isRequired: true`)

- Для `open`: поле не может быть пустым
- Для `single`: должна быть выбрана одна опция (или заполнено "Другое")
- Для `multi`: должен быть выбран хотя бы один вариант (или заполнено "Другое")
- Кнопка "Отправить" неактивна до выполнения условий

### Условные поля

- Для `single` с `conditionalText: true`:
  - Если выбрана положительная опция (yes/да), условное поле становится обязательным (если `isRequired: true`)
  - Кнопка "Отправить" неактивна, пока условное поле не заполнено

### Поле "Другое"

- Для `single`: можно ввести один собственный вариант
- Для `multi`: можно добавить несколько собственных вариантов через кнопку "+ Добавить еще вариант"

---

## Рендеринг вопросов

### Компонент `QuestionRenderer`

Определяет тип вопроса по `uiKind` и делегирует рендеринг соответствующему компоненту:

```typescript
switch (question.uiKind) {
  case 'open':
    return <OpenQuestion question={question} onSubmit={handleOpenSubmit} />;
  case 'single':
    return <SingleChoiceQuestion question={question} onSubmit={handleSingleSubmit} />;
  case 'multi':
    return <MultiChoiceQuestion question={question} onSubmit={handleMultiSubmit} />;
}
```

### Компоненты

- **`OpenQuestion`** — текстовое поле (`textarea`)
- **`SingleChoiceQuestion`** — радиокнопки (`radio buttons`) + опционально условное поле + опционально "Другое"
- **`MultiChoiceQuestion`** — чекбоксы (`checkboxes`) + опционально несколько полей "Другое"

---

## Итоговая таблица выбора типа вопроса

| Критерий | `open` | `single` | `multi` |
|----------|--------|---------|---------|
| **Количество вариантов** | Неизвестно / много | 2-7 вариантов | 2+ вариантов |
| **Тип выбора** | Свободный текст | Один вариант | Несколько вариантов |
| **Взаимоисключение** | Неприменимо | Да | Нет |
| **Примеры** | Описание предмета, порядок расчетов | Тип стороны, модель оплаты | Виды услуг, случаи ответственности |
| **UI элемент** | `textarea` | `radio buttons` | `checkboxes` |
| **Доп. возможности** | - | `conditionalText`, `allowOther` | `allowOther` |

---

## Заключение

Логика формирования уточняющих вопросов основана на:

1. **Типе собираемых данных** — определяет `valueType` и `uiKind`
2. **Этапе пайплайна** — шаг 1 (базовый контекст) vs шаг 3 (детали для пунктов)
3. **Режиме детализации** — влияет на количество и глубину вопросов
4. **Наличии информации** — не задавать вопросы, если данные уже есть
5. **Важности вопроса** — `requiredLevel` определяет приоритет

Система гибко комбинирует открытые и структурированные вопросы, позволяя собирать как свободные описания, так и структурированные данные для генерации юридических документов.


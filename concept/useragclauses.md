Окей, оформлю это как короткое ТЗ, которое можно прямо кидать в Notion/репу.

---

## Фича: генерация клауз по инструкции и эталонным формулировкам (Право(редактор))

### 1. Цель

Сделать так, чтобы клаузы в договоре:

* **не придумывались с нуля**,
* а **адаптировались** из заранее подготовленных эталонных формулировок,
* **строго привязанных к выбранной инструкции** (instructionId),
* с учётом ответов пользователя на этапе скелетона.

Результат для пользователя:
документ “как на рынке”, но под его конкретный кейс.

---

### 2. Исходные сущности

1. **Инструкция** (Instruction)

   * `id` (например, `inst_1eb7a465-...`)
   * `documentType`, `jurisdiction`, `language`, `documentMode`
   * `whenToUse`
   * `fullInstruction` (JSON с полями):

     * `recommendedStructure[]` — массив секций:

       * `sectionKey`
       * `title`
       * `description`
       * `isMandatory`
     * `styleHints`, `placeholdersUsed`, `instructionQuality`

2. **Эталонная клауза** (Clause)

   * `id` (например, `clause_1765304538098_c01rm94p2`)
   * `instructionId` — связь с инструкцией
   * `document_type` (строка)
   * `section_path` или `sectionKey` — к какой секции относится
   * `content` — текст эталонной формулировки с плейсхолдерами
   * `style`, `documentMode`
   * `approved` (bool)
   * `quality_score`

3. **Данные диалога по скелетону**

   * `generatedContext` — общий контекст документа
   * `terms` — словарь терминов
   * `skeleton` / `selectedSkeletonItems` — финальная структура документа
   * `skeletonItemAnswers` — ответы пользователя по каждому пункту скелета
     (ключ: itemKey / sectionKey + индекс пункта)

---

### 3. Поток на этапе генерации документа

**Шаг 4: генерация текста документа по готовой структуре**

Для **каждого пункта скелета**, вошедшего в `selectedSkeletonItems`:

1. Определяем связку:

   * `instructionId` документа (например, выбранная `inst_1eb7a465-...`)
   * `sectionKey` / `section_path` для текущего пункта

2. Ищем эталонную клаузу:

   * `instructionId == текущей инструкции`,
   * `section_path` или `sectionKey` совпадает с секцией пункта,
   * `documentMode` и/или `style` соответствует документу,
   * `approved == true`,
   * из них берём **лучшую** по `quality_score` (или первую, если одна).

3. Собираем контекст для генерации:

   * тип документа, юрисдикция, язык, режим (`documentMode`);
   * данные по секции: `sectionKey`, `title`, `description`;
   * общий контекст: `generatedContext`;
   * термины: `terms`;
   * ответы пользователя по этому пункту: `skeletonItemAnswers[itemKey]`;
   * эталонная формулировка: `clause.content`.

4. Отправляем всё в LLM с задачей:

> Взять базовый текст клаузы и **адаптировать** его под:
>
> * ответы пользователя,
> * контекст договора,
> * при этом сохранить правовую структуру и смысл эталона.

5. Результат — **одна финальная формулировка пункта**, которую записываем в модель документа (state/БД) как `generatedClause` для этого пункта.

---

### 4. Правила приоритета

При синтезе:

1. **База (клауза) → база права и рыночная структура**

   * сохраняем логику, конструкцию, последовательность условий;
   * плейсхолдеры остаются плейсхолдерами (не подставляем реальные данные).

2. **Ответы пользователя → конкретика кейса**

   * суммы, сроки, момент передачи, права/запреты и т.п.;
   * если ответы пользователя **конкретно противоречат** эталону:

     * эталон используется как шаблон,
     * значения подставляются по ответам пользователя,
     * недопустимые с точки зрения права настройки можно смягчать формулировкой, но не игнорировать.

3. **Никаких выдуманных фактов**

   * нельзя придумывать новые суммы, даты, реквизиты, если их нет в ответах/контексте;
   * нельзя менять тип договора/юрисдикцию.

---

### 5. Требования к поведению модели

1. Модель **не должна писать “с нуля”**, а должна:

   * опираться на `clause.content`,
   * изменять / вставлять параметры из `skeletonItemAnswers`,
   * при необходимости уточнять формулировку, но без изменения правовой сути.

2. Стиль:

   * нейтральный деловой, в духе `styleHints` из инструкции,
   * без разговорной лексики,
   * без пояснительных комментариев типа “эта клауза означает…” — только текст договора.

3. Структура:

   * одна законченая клауза (один пункт договора),
   * без списков и Markdown-структур в тексте договора,
   * без повторения заголовков (“Обстоятельства непреодолимой силы” и т.п.) — только содержимое пункта.

---

